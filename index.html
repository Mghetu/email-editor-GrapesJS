<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enhanced MJML Email Editor - Mobile Button Fixed</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/grapesjs@0.22.2/dist/css/grapes.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #gjs { height: 100vh; overflow: hidden; }
    
    .panel__right { position: fixed; right: 15px; top: 10px; display: flex; gap: 8px; z-index: 999; }
    
    /* Enhanced Button Styles */
    .panel__right .gjs-pn-btn {
      background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 6px; padding: 8px 12px; font-size: 13px; 
      transition: all 0.2s ease; border: none; cursor: pointer; color: #333;
      display: flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .panel__right .gjs-pn-btn:hover { 
      background: #f8f9fa; transform: translateY(-1px); 
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* Icon styling */
    .gjs-pn-btn i {
      font-size: 14px; line-height: 1; margin-right: 4px;
    }
    
    /* Default GrapesJS button styling with icons */
    .gjs-pn-buttons .gjs-pn-btn {
      display: flex; align-items: center; justify-content: center;
      padding: 8px 10px; font-size: 12px; gap: 4px;
    }
    
    /* Views panel buttons (left side) */
    .gjs-pn-panel.gjs-pn-views .gjs-pn-btn {
      border-radius: 4px; transition: all 0.2s ease;
    }
    
    /* Options panel buttons (right side) */
    .gjs-pn-panel.gjs-pn-options .gjs-pn-btn {
      border-radius: 4px; transition: all 0.2s ease;
    }
    
    /* Device buttons styling */
    .gjs-pn-panel.gjs-pn-devices .gjs-pn-btn {
      border-radius: 4px; transition: all 0.2s ease;
      min-width: 40px; justify-content: center;
    }
    
    .gjs-pn-panel.gjs-pn-devices .gjs-pn-btn.gjs-pn-active {
      background-color: #667eea; color: white;
    }
    
    .gjs-pn-panel.gjs-pn-devices .gjs-pn-btn:hover {
      background-color: #f0f0f0;
    }
    
    .gjs-pn-panel.gjs-pn-devices .gjs-pn-btn.gjs-pn-active:hover {
      background-color: #5a6fd8;
    }
    
    /* Custom device panel styling */
    .custom-device-panel {
      position: fixed !important;
      top: 10px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      display: flex !important;
      gap: 5px !important;
      z-index: 1000 !important;
      background: white !important;
      border-radius: 6px !important;
      padding: 5px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    .custom-device-btn {
      border: none !important;
      background: white !important;
      padding: 8px 12px !important;
      border-radius: 4px !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      font-size: 14px !important;
    }
    
    .custom-device-btn:hover {
      background: #f0f0f0 !important;
    }
    
    .custom-device-btn.active {
      background: #667eea !important;
      color: white !important;
    }
    
    /* Canvas responsive behavior */
    .gjs-cv-canvas {
      transition: width 0.3s ease;
    }
    
    /* Device preview indicators */
    .gjs-cv-canvas[data-device="Mobile"] {
      max-width: 320px;
    }
    
    .gjs-cv-canvas[data-device="Tablet"] {
      max-width: 768px;
    }
    
    /* Fallback for missing icons */
    .gjs-pn-btn i:before {
      font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands", "Font Awesome 5 Free", "Font Awesome 5 Brands" !important;
      font-weight: 900;
    }
    
    /* Ensure proper icon spacing in buttons */
    .gjs-pn-btn .fa, .gjs-pn-btn .fas, .gjs-pn-btn .far, .gjs-pn-btn .fab {
      margin-right: 4px;
    }
    
    /* Device buttons - icon only */
    .gjs-pn-devices .gjs-pn-btn .fa, 
    .gjs-pn-devices .gjs-pn-btn .fas {
      margin-right: 0;
    }
    
    /* Template modal icons */
    .template-preview i {
      font-size: 48px; color: #667eea; z-index: 1; position: relative;
    }
    
    /* Brand colors icons */
    .brand-colors h4 i {
      color: #667eea;
    }
    

    .gjs-blocks-cs { width: 280px; }
    .gjs-pn-panel.gjs-pn-views-container { border-left: 1px solid #e0e0e0; }
    
    /* Template Modal */
    .template-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 10000; display: none;
      align-items: center; justify-content: center;
    }
    
    .template-modal.active { display: flex; }
    
    .template-modal-content {
      background: white; border-radius: 12px; max-width: 90vw; max-height: 90vh;
      overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      display: flex; flex-direction: column; width: 800px;
    }
    
    .template-modal-header {
      padding: 20px 25px; border-bottom: 1px solid #e0e0e0;
      display: flex; justify-content: space-between; align-items: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .template-modal-header h2 { margin: 0; font-size: 20px; }
    
    .close-modal {
      background: none; border: none; color: white; font-size: 24px;
      cursor: pointer; padding: 5px; border-radius: 4px;
      transition: background 0.2s ease;
    }
    
    .close-modal:hover { background: rgba(255,255,255,0.1); }
    
    .template-categories {
      display: flex; gap: 10px; padding: 20px 25px; background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0; flex-wrap: wrap;
    }
    
    .category-btn {
      padding: 8px 16px; border: 1px solid #ddd; background: white;
      border-radius: 20px; cursor: pointer; font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .category-btn.active, .category-btn:hover {
      background: #667eea; color: white; border-color: #667eea;
    }
    
    .template-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px; padding: 25px; overflow-y: auto; max-height: 60vh;
    }
    
    .template-item {
      border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;
      cursor: pointer; transition: all 0.2s ease; background: white;
    }
    
    .template-item:hover {
      transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border-color: #667eea;
    }
    
    .template-preview {
      height: 180px; background: #f8f9fa; display: flex;
      align-items: center; justify-content: center; color: #667eea;
      font-size: 48px; position: relative; overflow: hidden;
    }
    
    .template-preview::before {
      content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                  linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                  linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                  linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      opacity: 0.3;
    }
    
    .template-preview i {
      position: relative; z-index: 1;
    }
    
    .template-info {
      padding: 15px; border-top: 1px solid #e0e0e0; background: white;
    }
    
    .template-name {
      font-weight: 600; margin-bottom: 5px; color: #333;
    }
    
    .template-description {
      font-size: 12px; color: #666; line-height: 1.4;
    }
    
    /* Brand Colors Panel */
    .brand-colors {
      position: fixed; right: 15px; top: 70px; background: white;
      border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none; z-index: 998; min-width: 200px;
    }
    
    .brand-colors.active { display: block; }
    
    .brand-colors h4 {
      margin: 0 0 15px 0; font-size: 14px; color: #333;
      display: flex; align-items: center; gap: 8px;
    }
    
    .color-palette {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
    }
    
    .color-swatch {
      width: 32px; height: 32px; border-radius: 4px; cursor: pointer;
      border: 2px solid transparent; transition: all 0.2s ease;
      position: relative;
    }
    
    .color-swatch:hover {
      border-color: #333; transform: scale(1.1);
    }
    
    .color-swatch::after {
      content: attr(title); position: absolute; bottom: -25px; left: 50%;
      transform: translateX(-50%); font-size: 10px; color: #666;
      white-space: nowrap; opacity: 0; transition: opacity 0.2s ease;
    }
    
    .color-swatch:hover::after {
      opacity: 1;
    }
    
    /* Loading state */
    .loading {
      display: inline-block; width: 20px; height: 20px;
      border: 3px solid #f3f3f3; border-top: 3px solid #667eea;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive enhancements */
    @media (max-width: 768px) {
      .template-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      .template-modal-content { width: 95vw; }
      .panel__right { 
        position: fixed; top: auto; bottom: 15px; right: 15px;
        flex-direction: column; gap: 8px;
      }
      .brand-colors {
        position: fixed; bottom: 100px; right: 15px; top: auto;
      }
    }
    
    /* Custom block styles */
    .gjs-block {
      border-radius: 6px; transition: all 0.2s ease;
    }
    
    .gjs-block:hover {
      transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Font Awesome fallback */
    @font-face {
      font-family: "Font Awesome 6 Free";
      font-display: swap;
    }
    
    /* Ensure icons load properly */
    .fa, .fas, .far, .fab {
      font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands", sans-serif !important;
      font-weight: 900;
    }
    
    .fab {
      font-family: "Font Awesome 6 Brands", sans-serif !important;
      font-weight: 400;
    }
    
    /* Icon fallback text for missing icons */
    .template-preview i:empty::before {
      content: "üìß";
      font-family: system-ui, sans-serif;
    }
    
    /* Additional fallbacks for GrapesJS default buttons if icons fail */
    .gjs-pn-btn:not(:has(i))::before {
      font-family: "Font Awesome 6 Free" !important;
      font-weight: 900;
      margin-right: 4px;
    }
    
    /* Fallback icons for specific buttons if JS fails */
    .gjs-pn-btn[data-tooltip="Blocks"]::before,
    .gjs-pn-btn[title*="Blocks"]::before { content: "‚äû "; }
    
    .gjs-pn-btn[data-tooltip="Layers"]::before,
    .gjs-pn-btn[title*="Layers"]::before { content: "üìã "; }
    
    .gjs-pn-btn[data-tooltip="Styles"]::before,
    .gjs-pn-btn[title*="Style"]::before { content: "üé® "; }
    
    .gjs-pn-btn[data-tooltip="Settings"]::before,
    .gjs-pn-btn[title*="Settings"]::before { content: "‚öô "; }
    
    .gjs-pn-btn[data-tooltip*="Code"]::before,
    .gjs-pn-btn[title*="Code"]::before { content: "üíª "; }
    
    .gjs-pn-btn[data-tooltip*="Full"]::before,
    .gjs-pn-btn[title*="Full"]::before { content: "‚õ∂ "; }
    
    .gjs-pn-btn[data-tooltip*="Preview"]::before,
    .gjs-pn-btn[title*="Preview"]::before { content: "üëÅ "; }
  </style>
</head>
<body>
  <div id="gjs"></div>
  
  <!-- Template Selection Modal -->
  <div id="templateModal" class="template-modal">
    <div class="template-modal-content">
      <div class="template-modal-header">
        <h2><i class="fas fa-th-large"></i> Choose a Template</h2>
        <button class="close-modal" onclick="closeTemplateModal()">&times;</button>
      </div>
      <div class="template-categories">
        <button class="category-btn active" data-category="all">All Templates</button>
        <button class="category-btn" data-category="newsletter">Newsletter</button>
        <button class="category-btn" data-category="promotional">Promotional</button>
        <button class="category-btn" data-category="welcome">Welcome</button>
        <button class="category-btn" data-category="ecommerce">E-commerce</button>
        <button class="category-btn" data-category="transactional">Transactional</button>
      </div>
      <div class="template-grid" id="templateGrid">
        <!-- Templates will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Brand Colors Panel -->
  <div id="brandColors" class="brand-colors">
    <h4><i class="fas fa-palette"></i> Brand Colors</h4>
    <div class="color-palette" id="colorPalette">
      <!-- Colors will be populated by JavaScript -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/grapesjs@0.22.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/grapesjs-mjml@1.0.5"></script>
  <script>
    // Global variables
    let editor;
    let isInitialized = false;

    // Template library data with actual MJML content
    const templates = {
      newsletter: [
        { 
          name: 'Modern Newsletter', 
          description: 'Clean and professional newsletter design', 
          icon: 'fas fa-newspaper',
          content: `<mjml>
  <mj-head>
    <mj-attributes>
      <mj-all font-family="Inter, Arial, sans-serif" />
      <mj-text font-size="14px" line-height="22px" color="#333" />
      <mj-section padding="0" />
      <mj-column padding="20px" />
    </mj-attributes>
    <mj-preview>Modern Newsletter - Stay updated with our latest news</mj-preview>
  </mj-head>
  <mj-body background-color="#f8f9fa">
    <mj-section background-color="#2c3e50" padding="20px 0">
      <mj-column>
        <mj-text color="white" font-size="24px" font-weight="bold" text-align="center">
          Company Newsletter
        </mj-text>
        <mj-text color="#ecf0f1" font-size="14px" text-align="center">
          Issue #42 | March 2025
        </mj-text>
      </mj-column>
    </mj-section>
    <mj-section background-color="white" padding="40px 20px">
      <mj-column>
        <mj-text font-size="20px" font-weight="600" color="#2c3e50">
          This Month's Highlights
        </mj-text>
        <mj-divider border-color="#ecf0f1" border-width="2px" />
        <mj-text>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
        </mj-text>
        <mj-button background-color="#3498db" color="white" border-radius="6px">
          Read More
        </mj-button>
      </mj-column>
    </mj-section>
  </mj-body>
</mjml>`
        },
        { 
          name: 'Creative Weekly', 
          description: 'Creative agency style newsletter', 
          icon: 'fas fa-palette',
          content: `<mjml>
  <mj-head>
    <mj-attributes>
      <mj-all font-family="Inter, Arial, sans-serif" />
    </mj-attributes>
    <mj-preview>Creative Weekly - Inspiration and Innovation</mj-preview>
  </mj-head>
  <mj-body background-color="#1a1a1a">
    <mj-section background-color="#ff6b6b" padding="30px 0">
      <mj-column>
        <mj-text color="white" font-size="32px" font-weight="bold" text-align="center">
          CREATIVE WEEKLY
        </mj-text>
        <mj-text color="white" font-size="16px" text-align="center">
          Design ‚Ä¢ Innovation ‚Ä¢ Inspiration
        </mj-text>
      </mj-column>
    </mj-section>
    <mj-section background-color="white" padding="40px 20px">
      <mj-column width="50%">
        <mj-image src="https://via.placeholder.com/300x200/4ecdc4/white?text=Feature" border-radius="8px" />
      </mj-column>
      <mj-column width="50%">
        <mj-text font-size="18px" font-weight="600" color="#2c3e50">
          Featured Design
        </mj-text>
        <mj-text>
          Discover the latest trends in creative design and get inspired by innovative projects.
        </mj-text>
        <mj-button background-color="#4ecdc4" color="white" border-radius="6px">
          Explore
        </mj-button>
      </mj-column>
    </mj-section>
  </mj-body>
</mjml>`
        }
      ],
      promotional: [
        { 
          name: 'Sale Announcement', 
          description: 'Eye-catching promotional template', 
          icon: 'fas fa-tag',
          content: `<mjml>
  <mj-head>
    <mj-preview>üî• Flash Sale - Up to 50% Off Everything!</mj-preview>
  </mj-head>
  <mj-body background-color="#fff">
    <mj-section background-color="#e74c3c" padding="40px 0">
      <mj-column>
        <mj-text color="white" font-size="36px" font-weight="bold" text-align="center">
          FLASH SALE
        </mj-text>
        <mj-text color="white" font-size="18px" text-align="center">
          Up to 50% OFF Everything
        </mj-text>
        <mj-text color="#ffeaa7" font-size="14px" text-align="center" padding="10px 0">
          Limited Time Only - Ends Midnight!
        </mj-text>
      </mj-column>
    </mj-section>
    <mj-section background-color="white" padding="40px 20px">
      <mj-column>
        <mj-text font-size="20px" text-align="center" color="#2d3436">
          Don't miss out on these incredible deals!
        </mj-text>
        <mj-button background-color="#e17055" color="white" font-size="16px" border-radius="25px" padding="15px 30px">
          SHOP NOW
        </mj-button>
        <mj-text font-size="12px" text-align="center" color="#636e72" padding="20px 0">
          *Terms and conditions apply. Valid until midnight EST.
        </mj-text>
      </mj-column>
    </mj-section>
  </mj-body>
</mjml>`
        }
      ],
      welcome: [
        { 
          name: 'Welcome Series', 
          description: 'Onboard new users with style', 
          icon: 'fas fa-hand-wave',
          content: `<mjml>
  <mj-head>
    <mj-preview>Welcome to our community! Let's get started.</mj-preview>
  </mj-head>
  <mj-body background-color="#f8f9fa">
    <mj-section background-color="#667eea" padding="50px 0">
      <mj-column>
        <mj-text color="white" font-size="28px" font-weight="bold" text-align="center">
          Welcome Aboard! üëã
        </mj-text>
        <mj-text color="white" font-size="16px" text-align="center" padding="15px 0">
          We're thrilled to have you join our community
        </mj-text>
      </mj-column>
    </mj-section>
    <mj-section background-color="white" padding="40px 20px">
      <mj-column>
        <mj-text font-size="18px" font-weight="600" color="#2c3e50">
          Here's what happens next:
        </mj-text>
        <mj-text>
          ‚úÖ Set up your profile<br>
          ‚úÖ Explore our features<br>
          ‚úÖ Connect with the community<br>
          ‚úÖ Start creating amazing content
        </mj-text>
        <mj-button background-color="#00cec9" color="white" border-radius="6px">
          Get Started
        </mj-button>
      </mj-column>
    </mj-section>
  </mj-body>
</mjml>`
        }
      ],
      ecommerce: [
        { 
          name: 'Product Showcase', 
          description: 'Showcase your products beautifully', 
          icon: 'fas fa-shopping-cart',
          content: `<mjml>
  <mj-head>
    <mj-preview>New arrivals - Check out our latest collection</mj-preview>
  </mj-head>
  <mj-body background-color="#f8f9fa">
    <mj-section background-color="#2d3436" padding="30px 0">
      <mj-column>
        <mj-text color="white" font-size="24px" font-weight="bold" text-align="center">
          NEW ARRIVALS
        </mj-text>
      </mj-column>
    </mj-section>
    <mj-section background-color="white" padding="40px 20px">
      <mj-column width="50%">
        <mj-image src="https://via.placeholder.com/300x300/6c5ce7/white?text=Product+1" border-radius="8px" />
        <mj-text font-weight="bold" font-size="16px" text-align="center" padding="10px 0 5px">
          Premium Product
        </mj-text>
        <mj-text color="#00b894" font-size="18px" font-weight="bold" text-align="center">
          $99.99
        </mj-text>
        <mj-button background-color="#6c5ce7" color="white" border-radius="6px" padding="10px 20px">
          Shop Now
        </mj-button>
      </mj-column>
      <mj-column width="50%">
        <mj-image src="https://via.placeholder.com/300x300/fd79a8/white?text=Product+2" border-radius="8px" />
        <mj-text font-weight="bold" font-size="16px" text-align="center" padding="10px 0 5px">
          Exclusive Item
        </mj-text>
        <mj-text color="#00b894" font-size="18px" font-weight="bold" text-align="center">
          $149.99
        </mj-text>
        <mj-button background-color="#fd79a8" color="white" border-radius="6px" padding="10px 20px">
          Shop Now
        </mj-button>
      </mj-column>
    </mj-section>
  </mj-body>
</mjml>`
        }
      ],
      transactional: [
        { 
          name: 'Order Confirmation', 
          description: 'Professional order confirmations', 
          icon: 'fas fa-check-circle',
          content: `<mjml>
  <mj-head>
    <mj-preview>Order Confirmation #12345 - Thank you for your purchase!</mj-preview>
  </mj-head>
  <mj-body background-color="#f8f9fa">
    <mj-section background-color="#00b894" padding="30px 0">
      <mj-column>
        <mj-text color="white" font-size="24px" font-weight="bold" text-align="center">
          Order Confirmed ‚úÖ
        </mj-text>
        <mj-text color="white" font-size="16px" text-align="center">
          Order #12345
        </mj-text>
      </mj-column>
    </mj-section>
    <mj-section background-color="white" padding="40px 20px">
      <mj-column>
        <mj-text font-size="18px" font-weight="600" color="#2c3e50">
          Thank you for your order!
        </mj-text>
        <mj-text>
          We've received your order and will send you a shipping confirmation email as soon as your items are on their way.
        </mj-text>
        <mj-divider border-color="#ddd" />
        <mj-text font-size="16px" font-weight="600" color="#2c3e50">
          Order Summary:
        </mj-text>
        <mj-text>
          Product Name x1 - $99.99<br>
          Shipping - $9.99<br>
          <strong>Total: $109.98</strong>
        </mj-text>
        <mj-button background-color="#0984e3" color="white" border-radius="6px">
          Track Your Order
        </mj-button>
      </mj-column>
    </mj-section>
  </mj-body>
</mjml>`
        }
      ]
    };

    // Brand colors
    const brandColors = [
      '#667eea', '#764ba2', '#f093fb', '#f5576c',
      '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
      '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3',
      '#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f'
    ];

    // Initialize editor
    function initializeEditor() {
      try {
        editor = grapesjs.init({
          container: '#gjs',
          height: '100vh',
          fromElement: false,
          storageManager: {
            id: 'enhanced-mjml-',
            type: 'local',
            autosave: true,
            autoload: true,
            stepsBeforeSave: 1,
          },
          deviceManager: {
            devices: [
              { name: 'Desktop', width: '' },
              { name: 'Tablet', width: '768px' },
              { name: 'Mobile', width: '320px' }
            ]
          },
          plugins: ['grapesjs-mjml'],
          pluginsOpts: { 'grapesjs-mjml': {} },
          styleManager: {
            sectors: [
              {
                name: 'Typography', open: false,
                buildProps: ['font-family', 'font-size', 'font-weight', 'letter-spacing', 'line-height', 'color', 'text-align', 'text-decoration', 'text-transform']
              },
              {
                name: 'Dimension', open: false,
                buildProps: ['width', 'height', 'min-height', 'max-width', 'padding', 'margin']
              },
              {
                name: 'Decorations', open: false,
                buildProps: ['background-color', 'background-image', 'border', 'border-radius', 'box-shadow', 'opacity']
              },
              {
                name: 'Layout', open: false,
                buildProps: ['display', 'position', 'top', 'right', 'bottom', 'left', 'z-index']
              }
            ]
          },
          canvas: {
            styles: [
              'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'
            ]
          }
        });

        setupPanels();
        setupCommands();
        setupCustomBlocks();
        setupDeviceChangeListener();
        
        isInitialized = true;

        // Check if this is a first-time user
        if (!editor.getComponents().length) {
          setTimeout(() => {
            const modal = document.getElementById('templateModal');
            if (modal) {
              modal.classList.add('active');
            }
          }, 1000);
        }

      } catch (error) {
        console.error('Error initializing editor:', error);
      }
    }

    // Set up panels
    function setupPanels() {
      const pn = editor.Panels;
      
      // Create only the right panel for our custom buttons
      pn.addPanel({ id: 'panel__right', el: (() => { const el = document.createElement('div'); el.className = 'panel__right'; document.body.appendChild(el); return el; })() });

      const addBtn = (panelId, opts) => pn.addButton(panelId, opts);
      
      // Add buttons to existing GrapesJS panels with proper icons
      addBtn('options', { 
        id: 'templates', 
        className: 'gjs-pn-btn', 
        label: `<i class="fas fa-th-large"></i>`, 
        attributes: { title: 'Templates' }, 
        command: 'open-templates' 
      });
      
      addBtn('options', { 
        id: 'clear', 
        className: 'gjs-pn-btn', 
        label: `<i class="fas fa-trash-alt"></i>`, 
        attributes: { title: 'Clear Canvas' }, 
        command: 'clear-canvas' 
      });

      // Right panel buttons (floating) with icons and text
      addBtn('panel__right', { 
        id: 'open-sm', 
        className: 'gjs-pn-btn', 
        label: `<i class="fas fa-paint-brush"></i> Style`, 
        command: 'open-sm' 
      });
      
      addBtn('panel__right', { 
        id: 'open-layers', 
        className: 'gjs-pn-btn', 
        label: `<i class="fas fa-layer-group"></i> Layers`, 
        command: 'open-layers' 
      });
      
      addBtn('panel__right', { 
        id: 'open-traits', 
        className: 'gjs-pn-btn', 
        label: `<i class="fas fa-cog"></i> Settings`, 
        command: 'open-traits' 
      });
      
      addBtn('panel__right', { 
        id: 'brand-colors', 
        className: 'gjs-pn-btn', 
        label: `<i class="fas fa-palette"></i> Colors`, 
        command: 'toggle-brand-colors' 
      });
    }

    // Set up commands
    function setupCommands() {
      editor.Commands.add('open-templates', {
        run() {
          const modal = document.getElementById('templateModal');
          if (modal) {
            modal.classList.add('active');
          }
        }
      });

      editor.Commands.add('toggle-brand-colors', {
        run() {
          const panel = document.getElementById('brandColors');
          if (panel) {
            panel.classList.toggle('active');
          }
        }
      });

      editor.Commands.add('clear-canvas', {
        run(ed) {
          if (confirm('Clear the canvas and start fresh?')) {
            ed.DomComponents.clear();
            ed.CssComposer.clear();
            ed.setComponents('<mjml><mj-body></mj-body></mjml>');
          }
        }
      });

      // Add custom device commands to ensure they work properly
      editor.Commands.add('set-device-desktop', {
        run(editor) {
          editor.setDevice('Desktop');
          console.log('Switching to Desktop view');
        }
      });

      editor.Commands.add('set-device-tablet', {
        run(editor) {
          editor.setDevice('Tablet');
          console.log('Switching to Tablet view');
        }
      });

      editor.Commands.add('set-device-mobile', {
        run(editor) {
          editor.setDevice('Mobile');
          console.log('Switching to Mobile view');
        }
      });
    }

    // Set up custom blocks
    function setupCustomBlocks() {
      editor.on('load', () => {
        // Add icons to existing GrapesJS buttons - call immediately and with delay
        addIconsToDefaultButtons();
        
        const openBlocks = editor.Panels.getButton('views', 'open-blocks');
        if (openBlocks) openBlocks.set('active', 1);
        
        const blockManager = editor.BlockManager;
        
        // Hero section block
        blockManager.add('hero-section', {
          label: 'Hero Section',
          category: 'Layout',
          content: `
            <mj-section background-color="#667eea" padding="60px 0">
              <mj-column>
                <mj-text color="white" font-size="28px" font-weight="bold" text-align="center">
                  Your Amazing Headline
                </mj-text>
                <mj-text color="white" font-size="16px" text-align="center" padding="20px 0">
                  Describe your amazing product or service here. Make it compelling and engaging.
                </mj-text>
                <mj-button background-color="white" color="#667eea" font-weight="bold">
                  Get Started
                </mj-button>
              </mj-column>
            </mj-section>
          `,
          attributes: { class: 'fa-star', title: 'Hero Section' }
        });

        // Product showcase block
        blockManager.add('product-showcase', {
          label: 'Product Grid',
          category: 'E-commerce',
          content: `
            <mj-section padding="40px 0">
              <mj-column width="50%">
                <mj-image src="https://via.placeholder.com/300x200/667eea/white?text=Product" alt="Product" border-radius="8px" />
                <mj-text font-weight="bold" font-size="18px" padding="15px 0 5px">Product Name</mj-text>
                <mj-text color="#666" font-size="14px">$99.99</mj-text>
                <mj-button background-color="#667eea" border-radius="6px" padding="10px 0">
                  Shop Now
                </mj-button>
              </mj-column>
              <mj-column width="50%">
                <mj-image src="https://via.placeholder.com/300x200/764ba2/white?text=Product" alt="Product" border-radius="8px" />
                <mj-text font-weight="bold" font-size="18px" padding="15px 0 5px">Product Name</mj-text>
                <mj-text color="#666" font-size="14px">$99.99</mj-text>
                <mj-button background-color="#764ba2" border-radius="6px" padding="10px 0">
                  Shop Now
                </mj-button>
              </mj-column>
            </mj-section>
          `,
          attributes: { class: 'fa-shopping-cart', title: 'Product Grid' }
        });

        // Social media block
        blockManager.add('social-media', {
          label: 'Social Links',
          category: 'Social',
          content: `
            <mj-section padding="30px 0">
              <mj-column>
                <mj-text text-align="center" font-size="18px" font-weight="bold" padding="0 0 20px">
                  Follow Us
                </mj-text>
                <mj-social font-size="15px" icon-size="30px" mode="horizontal" padding="0" text-padding="0 15px 0 0">
                  <mj-social-element name="facebook" href="#" />
                  <mj-social-element name="twitter" href="#" />
                  <mj-social-element name="instagram" href="#" />
                  <mj-social-element name="linkedin" href="#" />
                </mj-social>
              </mj-column>
            </mj-section>
          `,
          attributes: { class: 'fa-share-alt', title: 'Social Links' }
        });
      });
      
      // Also try adding icons after panels are ready
      editor.on('load', () => {
        setTimeout(() => {
          addIconsToDefaultButtons();
        }, 1000);
      });
    }

    // Add icons to default GrapesJS buttons
    function addIconsToDefaultButtons() {
      // Wait a bit for all panels to be ready
      setTimeout(() => {
        const buttonIcons = {
          // Views panel buttons
          'open-blocks': '<i class="fas fa-th"></i> Blocks',
          'open-layers': '<i class="fas fa-layer-group"></i> Layers', 
          'open-sm': '<i class="fas fa-paint-brush"></i> Styles',
          'open-traits': '<i class="fas fa-cog"></i> Settings',
          
          // Options panel buttons
          'export-template': '<i class="fas fa-code"></i> Code',
          'fullscreen': '<i class="fas fa-expand"></i> Full',
          'preview': '<i class="fas fa-eye"></i> Preview',
          
          // MJML specific buttons that might exist
          'mjml-import': '<i class="fas fa-upload"></i>',
          'mjml-export': '<i class="fas fa-download"></i>'
        };

        // Add icons to buttons in all panels
        Object.keys(buttonIcons).forEach(buttonId => {
          // Check in views panel
          let button = editor.Panels.getButton('views', buttonId);
          if (button) {
            button.set('label', buttonIcons[buttonId]);
            console.log(`Added icon to views/${buttonId}`);
          }
          
          // Check in options panel
          button = editor.Panels.getButton('options', buttonId);
          if (button) {
            button.set('label', buttonIcons[buttonId]);
            console.log(`Added icon to options/${buttonId}`);
          }
          
          // Check in any other panels
          const panels = editor.Panels.getAll();
          panels.forEach(panel => {
            const panelId = panel.get('id');
            if (panelId !== 'views' && panelId !== 'options') {
              button = editor.Panels.getButton(panelId, buttonId);
              if (button) {
                button.set('label', buttonIcons[buttonId]);
                console.log(`Added icon to ${panelId}/${buttonId}`);
              }
            }
          });
        });

        // Fallback: Search by button text content
        addIconsByTextContent();

        // Special handling for device buttons
        updateDeviceButtons();
        
        // Debug: List all available buttons
        console.log('Available panels and buttons:');
        const panels = editor.Panels.getAll();
        panels.forEach(panel => {
          const panelId = panel.get('id');
          const buttons = panel.get('buttons');
          if (buttons && buttons.length > 0) {
            console.log(`Panel ${panelId}:`, buttons.map(btn => btn.get('id')));
          }
        });
      }, 500);
    }

    // Fallback method: add icons by searching button text content
    function addIconsByTextContent() {
      const textToIcon = {
        'Blocks': '<i class="fas fa-th"></i> Blocks',
        'Layers': '<i class="fas fa-layer-group"></i> Layers',
        'Styles': '<i class="fas fa-paint-brush"></i> Styles',
        'Settings': '<i class="fas fa-cog"></i> Settings',
        'Code': '<i class="fas fa-code"></i> Code',
        'Full': '<i class="fas fa-expand"></i> Full',
        'Preview': '<i class="fas fa-eye"></i> Preview'
      };

      // Search through all panels and buttons
      const panels = editor.Panels.getAll();
      panels.forEach(panel => {
        const buttons = panel.get('buttons');
        if (buttons) {
          buttons.forEach(button => {
            const currentLabel = button.get('label');
            if (currentLabel && typeof currentLabel === 'string') {
              // Check if this button's label matches any of our target texts
              Object.keys(textToIcon).forEach(text => {
                if (currentLabel.toLowerCase().includes(text.toLowerCase()) && !currentLabel.includes('<i')) {
                  button.set('label', textToIcon[text]);
                  console.log(`Added icon by text search: ${text} -> ${textToIcon[text]}`);
                }
              });
            }
          });
        }
      });
    }

    // Update device buttons with icons and proper commands
    function updateDeviceButtons() {
      const deviceManager = editor.DeviceManager;
      const devices = deviceManager.getAll();
      
      // Try different panel names for device buttons
      const devicePanelNames = ['devices', 'devices-c', 'device-manager'];
      
      devices.forEach(device => {
        const deviceName = device.get('name');
        const deviceId = device.get('id') || deviceName.toLowerCase();
        
        let icon = '<i class="fas fa-desktop"></i>';
        let title = deviceName;
        
        if (deviceName.toLowerCase().includes('mobile')) {
          icon = '<i class="fas fa-mobile-alt"></i>';
        } else if (deviceName.toLowerCase().includes('tablet')) {
          icon = '<i class="fas fa-tablet-alt"></i>';
        }
        
        // Try different button ID patterns
        const buttonIds = [
          `set-device-${deviceId}`,
          `device-${deviceId}`,
          deviceId,
          deviceName.toLowerCase()
        ];
        
        devicePanelNames.forEach(panelName => {
          buttonIds.forEach(buttonId => {
            const button = editor.Panels.getButton(panelName, buttonId);
            if (button) {
              button.set('label', icon);
              button.set('attributes', { title: title });
              // Ensure the button has the proper command
              button.set('command', (editor, sender) => {
                editor.setDevice(deviceName);
                // Update button active state
                const panel = editor.Panels.getPanel(panelName);
                if (panel) {
                  const buttons = panel.get('buttons');
                  buttons.forEach(btn => btn.set('active', false));
                  sender.set('active', true);
                }
              });
              console.log(`Added icon and command to device button ${panelName}/${buttonId}`);
            }
          });
        });
      });
      
      // Additional fallback: manually check for device buttons in DOM and fix them
      setTimeout(() => {
        fixDeviceButtonsDirectly();
      }, 1000);
    }

    // Set up device change listener for debugging and proper functionality
    function setupDeviceChangeListener() {
      // Listen for device changes
      editor.on('change:device', () => {
        const currentDevice = editor.getDevice();
        console.log('Device changed to:', currentDevice);
        
        // Force canvas refresh
        const canvas = editor.Canvas;
        if (canvas) {
          canvas.refresh();
        }
        
        // Update active button states
        updateDeviceButtonStates(currentDevice);
      });
      
      // Also listen for device manager events
      const deviceManager = editor.DeviceManager;
      deviceManager.on('change:device', (device) => {
        console.log('Device manager changed to:', device.get('name'));
      });
    }

    // Update device button active states
    function updateDeviceButtonStates(currentDevice) {
      const deviceButtons = document.querySelectorAll('.gjs-pn-btn');
      
      deviceButtons.forEach(button => {
        const buttonText = button.textContent || button.innerHTML;
        const isActive = buttonText.includes(currentDevice) || 
                        (currentDevice === 'Desktop' && buttonText.includes('desktop')) ||
                        (currentDevice === 'Tablet' && buttonText.includes('tablet')) ||
                        (currentDevice === 'Mobile' && buttonText.includes('mobile'));
        
        if (isActive) {
          button.classList.add('gjs-pn-active');
        } else {
          button.classList.remove('gjs-pn-active');
        }
      });
    }
    function fixDeviceButtonsDirectly() {
      // Find device buttons by their likely class names or content
      const deviceButtons = document.querySelectorAll('.gjs-pn-btn');
      
      deviceButtons.forEach(button => {
        const buttonText = button.textContent || button.innerHTML;
        const buttonTitle = button.title || button.getAttribute('title');
        
        // Check if this looks like a device button
        if (buttonText.includes('Desktop') || buttonTitle?.includes('Desktop')) {
          button.innerHTML = '<i class="fas fa-desktop"></i>';
          button.onclick = () => editor.setDevice('Desktop');
        } else if (buttonText.includes('Tablet') || buttonTitle?.includes('Tablet')) {
          button.innerHTML = '<i class="fas fa-tablet-alt"></i>';
          button.onclick = () => editor.setDevice('Tablet');
        } else if (buttonText.includes('Mobile') || buttonTitle?.includes('Mobile')) {
          button.innerHTML = '<i class="fas fa-mobile-alt"></i>';
          button.onclick = () => editor.setDevice('Mobile');
        }
      });
      
      // Also check for buttons without text but with specific attributes
      const allButtons = document.querySelectorAll('[data-command*="device"], [class*="device"]');
      allButtons.forEach(button => {
        const command = button.getAttribute('data-command') || '';
        if (command.includes('desktop')) {
          button.innerHTML = '<i class="fas fa-desktop"></i>';
          button.onclick = () => editor.setDevice('Desktop');
        } else if (command.includes('tablet')) {
          button.innerHTML = '<i class="fas fa-tablet-alt"></i>';
          button.onclick = () => editor.setDevice('Tablet');
        } else if (command.includes('mobile')) {
          button.innerHTML = '<i class="fas fa-mobile-alt"></i>';
          button.onclick = () => editor.setDevice('Mobile');
        }
      });
    }

    // Template functions
    function populateTemplateGrid() {
      const grid = document.getElementById('templateGrid');
      if (!grid) return;
      
      grid.innerHTML = '';
      
      Object.keys(templates).forEach(category => {
        templates[category].forEach(template => {
          const item = document.createElement('div');
          item.className = 'template-item';
          item.dataset.category = category;
          item.innerHTML = `
            <div class="template-preview">
              <i class="${template.icon}"></i>
            </div>
            <div class="template-info">
              <div class="template-name">${template.name}</div>
              <div class="template-description">${template.description}</div>
            </div>
          `;
          item.addEventListener('click', () => loadTemplate(template));
          grid.appendChild(item);
        });
      });
    }

    function loadTemplate(template) {
      if (!editor || !isInitialized) {
        console.error('Editor not initialized');
        return;
      }

      try {
        if (template.content) {
          editor.setComponents(template.content);
          editor.setStyle('');
        } else {
          console.warn('Template has no content');
        }
        closeTemplateModal();
      } catch (error) {
        console.error('Error loading template:', error);
      }
    }

    function closeTemplateModal() {
      const modal = document.getElementById('templateModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    function filterTemplates(category) {
      const items = document.querySelectorAll('.template-item');
      items.forEach(item => {
        if (category === 'all' || item.dataset.category === category) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function populateBrandColors() {
      const palette = document.getElementById('colorPalette');
      if (!palette) return;
      
      palette.innerHTML = '';
      brandColors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = color;
        swatch.title = color;
        swatch.addEventListener('click', () => {
          if (editor && isInitialized) {
            const selected = editor.getSelected();
            if (selected) {
              selected.addStyle({ 'background-color': color });
            } else {
              // Copy color to clipboard
              navigator.clipboard.writeText(color).then(() => {
                console.log('Color copied to clipboard:', color);
              });
            }
          }
        });
        palette.appendChild(swatch);
      });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Check if Font Awesome is loaded
      const checkFontAwesome = () => {
        const testIcon = document.createElement('i');
        testIcon.className = 'fas fa-home';
        testIcon.style.position = 'absolute';
        testIcon.style.left = '-9999px';
        document.body.appendChild(testIcon);
        
        const computedStyle = window.getComputedStyle(testIcon, ':before');
        const isLoaded = computedStyle.content !== 'none' && computedStyle.content !== '';
        
        document.body.removeChild(testIcon);
        
        if (!isLoaded) {
          console.warn('Font Awesome not loaded, using fallback icons');
          // Add fallback styling if needed
          const style = document.createElement('style');
          style.textContent = `
            .fa, .fas, .far, .fab {
              font-family: system-ui, sans-serif !important;
            }
            .fa-th-large::before { content: "‚äû"; }
            .fa-trash-alt::before { content: "üóë"; }
            .fa-paint-brush::before { content: "üé®"; }
            .fa-layer-group::before { content: "üìã"; }
            .fa-cog::before { content: "‚öô"; }
            .fa-palette::before { content: "üé®"; }
          `;
          document.head.appendChild(style);
        }
      };
      
      // Check Font Awesome after a short delay
      setTimeout(checkFontAwesome, 1000);
      
      // Initialize editor
      initializeEditor();
      
      // Populate UI elements
      populateTemplateGrid();
      populateBrandColors();
      
      // Category filter
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          filterTemplates(e.target.dataset.category);
        });
      });
      
      // Close modal on outside click
      const templateModal = document.getElementById('templateModal');
      if (templateModal) {
        templateModal.addEventListener('click', (e) => {
          if (e.target.classList.contains('template-modal')) {
            closeTemplateModal();
          }
        });
      }

      // Close brand colors panel when clicking outside
      document.addEventListener('click', (e) => {
        const brandColors = document.getElementById('brandColors');
        const brandColorBtn = document.querySelector('[data-command="toggle-brand-colors"]');
        
        if (brandColors && !brandColors.contains(e.target) && e.target !== brandColorBtn) {
          brandColors.classList.remove('active');
        }
      });
    });

    // Global functions for HTML onclick handlers
    window.closeTemplateModal = closeTemplateModal;

    // Export editor globally for debugging
    window.editor = editor;
  </script>
</body>
</html>