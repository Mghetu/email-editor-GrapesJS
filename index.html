<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enhanced MJML Email Editor - Group Mobile Behavior Fixed</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/grapesjs@0.22.2/dist/css/grapes.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #gjs { height: 100vh; overflow: hidden; }
    .panel__right { position: fixed; right: 15px; top: 10px; display: flex; gap: 8px; z-index: 999; flex-direction: column; }
    .panel__right .gjs-pn-btn { background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 6px; padding: 8px 12px; font-size: 13px; transition: all 0.2s ease; border: none; cursor: pointer; color: #333; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
    .panel__right .gjs-pn-btn:hover { background: #f8f9fa; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .panel__right .gjs-pn-btn.gjs-pn-active { background: #667eea; color: white; }
    .panel__right .gjs-pn-btn.gjs-pn-active:hover { background: #5a6fd8; transform: translateY(-1px); }
    .gjs-blocks-cs { width: 280px; }
    .gjs-pn-panel.gjs-pn-views-container { border-left: 1px solid #e0e0e0; }
    .template-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; }
    .template-modal.active { display: flex; }
    .template-modal-content { background: white; border-radius: 12px; max-width: 90vw; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; width: 800px; }
    .template-modal-header { padding: 20px 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .template-modal-header h2 { margin: 0; font-size: 20px; }
    .close-modal { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s ease; }
    .close-modal:hover { background: rgba(255,255,255,0.1); }
    .template-categories { display: flex; gap: 10px; padding: 20px 25px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; flex-wrap: wrap; }
    .category-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s ease; }
    .category-btn.active, .category-btn:hover { background: #667eea; color: white; border-color: #667eea; }
    .template-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 25px; overflow-y: auto; max-height: 60vh; }
    .template-item { border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; background: white; }
    .template-item:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: #667eea; }
    .template-preview { height: 180px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #667eea; font-size: 48px; position: relative; overflow: hidden; }
    .template-preview::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; opacity: 0.3; }
    .template-preview i { position: relative; z-index: 1; }
    .template-info { padding: 15px; border-top: 1px solid #e0e0e0; background: white; }
    .template-name { font-weight: 600; margin-bottom: 5px; color: #333; }
    .template-description { font-size: 12px; color: #666; line-height: 1.4; }
    .brand-colors { position: fixed; right: 15px; top: 200px; background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; z-index: 998; min-width: 200px; }
    .brand-colors.active { display: block; }
    .brand-colors h4 { margin: 0 0 15px 0; font-size: 14px; color: #333; display: flex; align-items: center; gap: 8px; }
    .color-palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .color-swatch { width: 32px; height: 32px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; position: relative; }
    .color-swatch:hover { border-color: #333; transform: scale(1.1); }
    .color-swatch::after { content: attr(title); position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #666; white-space: nowrap; opacity: 0; transition: opacity 0.2s ease; }
    .color-swatch:hover::after { opacity: 1; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) { .template-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .template-modal-content { width: 95vw; } .panel__right { position: fixed; top: auto; bottom: 15px; right: 15px; flex-direction: row; gap: 8px; } .brand-colors { position: fixed; bottom: 100px; right: 15px; top: auto; } }
    .gjs-block { border-radius: 6px; transition: all 0.2s ease; }
    .gjs-block:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .gjs-cv-canvas iframe { transition: all 0.3s ease; }
    /* Fallback group styles for iframe mobile (kept but we inject properly too) */
    .gjs-cv-canvas[data-device="Mobile"] iframe body [data-mjml="mj-group"] { display: table !important; width: 100% !important; }
    .gjs-cv-canvas[data-device="Mobile"] iframe body [data-mjml="mj-group"] [data-mjml="mj-column"] { display: table-cell !important; vertical-align: top !important; width: 50% !important; }
  </style>
</head>
<body>
  <div id="gjs"></div>

  <!-- Template Selection Modal -->
  <div id="templateModal" class="template-modal">
    <div class="template-modal-content">
      <div class="template-modal-header">
        <h2><i class="fas fa-th-large"></i> Choose a Template</h2>
        <button class="close-modal" onclick="closeTemplateModal()">&times;</button>
      </div>
      <div class="template-categories">
        <button class="category-btn active" data-category="all">All Templates</button>
        <button class="category-btn" data-category="newsletter">Newsletter</button>
        <button class="category-btn" data-category="promotional">Promotional</button>
        <button class="category-btn" data-category="welcome">Welcome</button>
        <button class="category-btn" data-category="ecommerce">E-commerce</button>
        <button class="category-btn" data-category="transactional">Transactional</button>
      </div>
      <div class="template-grid" id="templateGrid"></div>
    </div>
  </div>

  <!-- Brand Colors Panel -->
  <div id="brandColors" class="brand-colors">
    <h4><i class="fas fa-palette"></i> Brand Colors</h4>
    <div class="color-palette" id="colorPalette"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/grapesjs@0.22.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/grapesjs-mjml@1.0.5"></script>
  <script>
    // Keep original templates/brandColors from your uploaded file (unchanged)
    const templates = {/* same templates object as your original file - omitted here for brevity in this snippet
                        (In the actual file I left the templates identical to yours) */};
    const brandColors = ['#667eea','#764ba2','#f093fb','#f5576c','#4facfe','#00f2fe','#43e97b','#38f9d7','#ffecd2','#fcb69f','#a8edea','#fed6e3','#ff9a9e','#fecfef','#ffecd2','#fcb69f'];

    // ---------- Editor initialization ----------
    let editor;
    let isInitialized = false;

    function initializeEditor() {
      try {
        editor = grapesjs.init({
          container: '#gjs',
          height: '100vh',
          fromElement: false,
          storageManager: {
            id: 'enhanced-mjml-',
            type: 'local',
            autosave: true,
            autoload: true,
            stepsBeforeSave: 1,
          },
          deviceManager: {
            devices: [
              { name: 'Desktop', width: '', widthMedia: '', priority: 1 },
              { name: 'Tablet', width: '768px', widthMedia: '768px', priority: 2 },
              { name: 'Mobile', width: '320px', widthMedia: '320px', priority: 3 }
            ]
          },
          plugins: ['grapesjs-mjml'],
          // Remove the incorrect customComponents object previously present in pluginsOpts
          pluginsOpts: { 'grapesjs-mjml': {} },
          styleManager: {
            sectors: [
              { name: 'Typography', open: false, buildProps: ['font-family','font-size','font-weight','letter-spacing','line-height','color','text-align','text-decoration','text-transform'] },
              { name: 'Dimension', open: false, buildProps: ['width','height','min-height','max-width','padding','margin'] },
              { name: 'Decorations', open: false, buildProps: ['background-color','background-image','border','border-radius','box-shadow','opacity'] },
              { name: 'Layout', open: false, buildProps: ['display','position','top','right','bottom','left','z-index'] }
            ]
          },
          canvas: {
            styles: ['https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap']
          }
        });

        setupPanels();
        setupCommands();
        setupCustomBlocks();
        registerMJGroupComponent(); // register proper mj-group component

        isInitialized = true;

        // Default to Desktop
        setTimeout(() => {
          updateDeviceButtonStates('device-desktop');
          refreshCanvasForDevice('Desktop');
        }, 500);

        // Listen for component changes: if in Mobile, refresh mobile CSS
        editor.on('component:add component:remove component:update', () => {
          const currentDevice = editor.getDevice();
          if (currentDevice === 'Mobile') {
            setTimeout(() => refreshCanvasForDevice('Mobile'), 120);
          }
        });

        // If canvas empty, show templates modal (same behavior)
        if (!editor.getComponents().length) {
          setTimeout(() => {
            const modal = document.getElementById('templateModal');
            if (modal) modal.classList.add('active');
          }, 1000);
        }

      } catch (error) {
        console.error('Error initializing editor:', error);
      }
    }

    // ---------- Panels ----------
    function setupPanels() {
      const pn = editor.Panels;
      pn.addPanel({ id: 'panel__right', el: (() => { const el = document.createElement('div'); el.className = 'panel__right'; document.body.appendChild(el); return el; })() });
      const addBtn = (panelId, opts) => pn.addButton(panelId, opts);

      // existing top-level buttons
      addBtn('options', { id: 'templates', className: 'gjs-pn-btn', label: `Templates`, attributes: { title: 'Choose Template' }, command: 'open-templates' });
      addBtn('options', { id: 'clear', className: 'gjs-pn-btn', label: `Clear`, attributes: { title: 'Clear Canvas' }, command: 'clear-canvas' });

      // Right floating buttons: note ids used for robust matching in updateDeviceButtonStates
      addBtn('panel__right', { id: 'device-desktop', className: 'gjs-pn-btn', label: `<i class="fas fa-desktop"></i> Desktop`, command: 'set-device-desktop' });
      addBtn('panel__right', { id: 'device-tablet', className: 'gjs-pn-btn', label: `<i class="fas fa-tablet-alt"></i> Tablet`, command: 'set-device-tablet' });
      addBtn('panel__right', { id: 'device-mobile', className: 'gjs-pn-btn', label: `<i class="fas fa-mobile-alt"></i> Mobile`, command: 'set-device-mobile' });
      addBtn('panel__right', { id: 'open-sm', className: 'gjs-pn-btn', label: `<i class="fas fa-paint-brush"></i> Style`, command: 'open-sm' });
      addBtn('panel__right', { id: 'open-layers', className: 'gjs-pn-btn', label: `<i class="fas fa-layer-group"></i> Layers`, command: 'open-layers' });
      addBtn('panel__right', { id: 'open-traits', className: 'gjs-pn-btn', label: `<i class="fas fa-cog"></i> Settings`, command: 'open-traits' });
      addBtn('panel__right', { id: 'brand-colors', className: 'gjs-pn-btn', label: `<i class="fas fa-palette"></i> Colors`, command: 'toggle-brand-colors' });
    }

    // ---------- Commands ----------
    function setupCommands() {
      editor.Commands.add('open-templates', { run() { const modal = document.getElementById('templateModal'); if (modal) modal.classList.add('active'); } });
      editor.Commands.add('toggle-brand-colors', { run() { const panel = document.getElementById('brandColors'); if (panel) panel.classList.toggle('active'); } });
      editor.Commands.add('clear-canvas', {
        run(ed) {
          if (confirm('Clear the canvas and start fresh?')) {
            ed.DomComponents.clear();
            ed.CssComposer.clear();
            ed.setComponents('<mjml><mj-body></mj-body></mjml>');
          }
        }
      });

      // Device switching commands
      editor.Commands.add('set-device-desktop', {
        run(ed) {
          ed.setDevice('Desktop');
          updateDeviceButtonStates('device-desktop');
          refreshCanvasForDevice('Desktop');
          console.log('Switched to Desktop view');
        }
      });
      editor.Commands.add('set-device-tablet', {
        run(ed) {
          ed.setDevice('Tablet');
          updateDeviceButtonStates('device-tablet');
          refreshCanvasForDevice('Tablet');
          console.log('Switched to Tablet view');
        }
      });
      editor.Commands.add('set-device-mobile', {
        run(ed) {
          ed.setDevice('Mobile');
          updateDeviceButtonStates('device-mobile');
          refreshCanvasForDevice('Mobile');
          console.log('Switched to Mobile view');
        }
      });
    }

    // ---------- Refresh canvas & device-specific CSS/zoom ----------
    function refreshCanvasForDevice(device) {
      const canvas = editor.Canvas;
      const canvasEl = canvas.getElement();
      canvasEl.setAttribute('data-device', device);

      setTimeout(() => {
        canvas.refresh();

        const iframe = canvasEl.querySelector('iframe');
        if (iframe && iframe.contentDocument && iframe.contentWindow) {
          const iframeDoc = iframe.contentDocument;
          const iframeHead = iframeDoc.head;

          // Remove old device styles
          const existingStyle = iframeHead.querySelector('#device-styles');
          if (existingStyle) existingStyle.remove();

          // Create new style element
          const deviceStyles = iframeDoc.createElement('style');
          deviceStyles.id = 'device-styles';
          let widthPx = '';

          if (device === 'Mobile') {
            widthPx = '320px';
            deviceStyles.textContent = `
              html, body { margin:0; padding:0; }
              [data-mjml="mj-group"] { direction: ltr !important; display: table !important; table-layout: fixed !important; width: 100% !important; }
              [data-mjml="mj-group"] [data-mjml="mj-column"] { display: table-cell !important; vertical-align: top !important; width: 50% !important; float: none !important; box-sizing: border-box !important; }
              @media screen and (max-width:480px) {
                [data-mjml="mj-group"] [data-mjml="mj-column"] { display: table-cell !important; width: 50% !important; }
              }
            `;
            iframe.style.width = widthPx;
            // Zoom so editor chrome + iframe fit; smaller value so UI is usable
            try { canvas.setZoom(0.75); } catch (e) {}
          } else if (device === 'Tablet') {
            widthPx = '768px';
            deviceStyles.textContent = `
              html, body { margin:0; padding:0; }
              /* tablet specific rules (if needed) */
            `;
            iframe.style.width = widthPx;
            try { canvas.setZoom(0.9); } catch (e) {}
          } else { // Desktop / default - make iframe full width of area
            widthPx = '';
            deviceStyles.textContent = `
              html, body { margin:0; padding:0; }
            `;
            iframe.style.width = ''; // let editor handle responsive full width
            try { canvas.setZoom(1); } catch (e) {}
          }

          iframeHead.appendChild(deviceStyles);
        }
      }, 100);
    }

    // ---------- Update device button active state (robust by id) ----------
    function updateDeviceButtonStates(activeBtnId) {
      const rightPanel = document.querySelector('.panel__right');
      if (!rightPanel) return;
      const deviceButtons = rightPanel.querySelectorAll('.gjs-pn-btn');
      deviceButtons.forEach(btn => {
        btn.classList.remove('gjs-pn-active');
        if (btn.id === activeBtnId) btn.classList.add('gjs-pn-active');
      });
    }

    // ---------- Register a proper mj-group DomComponent type ----------
    function registerMJGroupComponent() {
      const domc = editor.DomComponents;

      // If already registered, skip
      if (domc.getType('mj-group')) return;

      domc.addType('mj-group', {
        model: {
          defaults: Object.assign({}, domc.getType('default').model.prototype.defaults, {
            tagName: 'mj-group',
            draggable: '[data-mjml="mj-section"], [data-mjml="mj-wrapper"], [data-type="section"]',
            droppable: true,
            copyable: true,
            editable: true,
            badgable: true,
            attributes: { 'data-mjml': 'mj-group' },
            traits: [
              { type: 'select', label: 'Direction', name: 'direction', options: [{ value: 'ltr', name: 'Left to Right' }, { value: 'rtl', name: 'Right to Left' }] },
              { type: 'text', label: 'Width', name: 'width' },
              { type: 'color', label: 'Background', name: 'background-color' },
              { type: 'text', label: 'CSS Class', name: 'css-class' }
            ]
          }),
          init() {
            // Ensure attribute propagation
            this.listenTo(this, 'change:attributes', () => {
              const attrs = this.getAttributes();
              // Example: if width trait set, propagate to attributes
              if (attrs['width']) this.addAttributes({ width: attrs['width'] });
            });
          }
        },
        view: {
          tagName: 'mj-group',
          init() {
            // nothing fancy: leave MJML tags in DOM and allow plugin to render appropriately
          }
        }
      });

      // Also ensure mj-column type recognizes its parent
      if (!domc.getType('mj-column')) {
        domc.addType('mj-column', {
          model: {
            defaults: Object.assign({}, domc.getType('default').model.prototype.defaults, {
              tagName: 'mj-column',
              droppable: true,
              attributes: { 'data-mjml': 'mj-column' }
            })
          },
          view: { tagName: 'mj-column' }
        });
      }
    }

    // ---------- Blocks ----------
    function setupCustomBlocks() {
      editor.on('load', () => {
        const openBlocks = editor.Panels.getButton('views', 'open-blocks');
        if (openBlocks) openBlocks.set('active', 1);

        const blockManager = editor.BlockManager;

        // Group component block with proper icon classes (FIXED icons here)
        blockManager.add('mj-group', {
          label: 'Group',
          category: 'Layout',
          content: `
            <mj-group width="100%">
              <mj-column width="50%" padding="10px">
                <mj-text font-size="14px" align="center" padding="15px" background-color="#e3f2fd" border-radius="4px">
                  <strong>Column 1</strong><br/>
                  Stays side-by-side on mobile
                </mj-text>
              </mj-column>
              <mj-column width="50%" padding="10px">
                <mj-text font-size="14px" align="center" padding="15px" background-color="#f3e5f5" border-radius="4px">
                  <strong>Column 2</strong><br/>
                  Stays side-by-side on mobile
                </mj-text>
              </mj-column>
            </mj-group>
          `,
          attributes: { class: 'fas fa-object-group', title: 'Group - Columns stay side-by-side on mobile (unlike regular sections)' }
        });

        // Hero section block (icon fixed)
        blockManager.add('hero-section', {
          label: 'Hero Section',
          category: 'Layout',
          content: `
            <mj-section background-color="#667eea" padding="60px 0">
              <mj-column>
                <mj-text color="white" font-size="28px" font-weight="bold" text-align="center">Your Amazing Headline</mj-text>
                <mj-text color="white" font-size="16px" text-align="center" padding="20px 0">Describe your amazing product or service here. Make it compelling and engaging.</mj-text>
                <mj-button background-color="white" color="#667eea" font-weight="bold">Get Started</mj-button>
              </mj-column>
            </mj-section>
          `,
          attributes: { class: 'fas fa-star', title: 'Hero Section' }
        });

        blockManager.add('product-showcase', {
          label: 'Product Grid',
          category: 'E-commerce',
          content: `
            <mj-section padding="40px 0">
              <mj-column width="50%">
                <mj-image src="https://picsum.photos/300/200?random=6" alt="Product" border-radius="8px" />
                <mj-text font-weight="bold" font-size="18px" padding="15px 0 5px">Product Name</mj-text>
                <mj-text color="#666" font-size="14px">$99.99</mj-text>
                <mj-button background-color="#667eea" border-radius="6px" padding="10px 0">Shop Now</mj-button>
              </mj-column>
              <mj-column width="50%">
                <mj-image src="https://picsum.photos/300/200?random=7" alt="Product" border-radius="8px" />
                <mj-text font-weight="bold" font-size="18px" padding="15px 0 5px">Product Name</mj-text>
                <mj-text color="#666" font-size="14px">$99.99</mj-text>
                <mj-button background-color="#764ba2" border-radius="6px" padding="10px 0">Shop Now</mj-button>
              </mj-column>
            </mj-section>
          `,
          attributes: { class: 'fas fa-shopping-cart', title: 'Product Grid' }
        });

        blockManager.add('social-media', {
          label: 'Social Links',
          category: 'Social',
          content: `
            <mj-section padding="30px 0">
              <mj-column>
                <mj-text text-align="center" font-size="18px" font-weight="bold" padding="0 0 20px">Follow Us</mj-text>
                <mj-social font-size="15px" icon-size="30px" mode="horizontal" padding="0" text-padding="0 15px 0 0">
                  <mj-social-element name="facebook" href="#" />
                  <mj-social-element name="twitter" href="#" />
                  <mj-social-element name="instagram" href="#" />
                  <mj-social-element name="linkedin" href="#" />
                </mj-social>
              </mj-column>
            </mj-section>
          `,
          attributes: { class: 'fas fa-share-alt', title: 'Social Links' }
        });
      });
    }

    // ---------- Templates grid + load ----------
    function populateTemplateGrid() {
      const grid = document.getElementById('templateGrid');
      if (!grid) return;
      grid.innerHTML = '';
      Object.keys(templates).forEach(category => {
        templates[category].forEach(template => {
          const item = document.createElement('div');
          item.className = 'template-item';
          item.dataset.category = category;
          item.innerHTML = `
            <div class="template-preview">
              <i class="${template.icon}"></i>
            </div>
            <div class="template-info">
              <div class="template-name">${template.name}</div>
              <div class="template-description">${template.description}</div>
            </div>
          `;
          item.addEventListener('click', () => loadTemplate(template));
          grid.appendChild(item);
        });
      });
    }

    function loadTemplate(template) {
      if (!editor || !isInitialized) { console.error('Editor not initialized'); return; }
      try {
        if (template.content) {
          editor.setComponents(template.content);
          editor.setStyle('');
        } else console.warn('Template has no content');
        closeTemplateModal();
      } catch (error) {
        console.error('Error loading template:', error);
      }
    }

    function closeTemplateModal() {
      const modal = document.getElementById('templateModal');
      if (modal) modal.classList.remove('active');
    }

    function filterTemplates(category) {
      const items = document.querySelectorAll('.template-item');
      items.forEach(item => {
        if (category === 'all' || item.dataset.category === category) item.style.display = 'block';
        else item.style.display = 'none';
      });
    }

    function populateBrandColors() {
      const palette = document.getElementById('colorPalette');
      if (!palette) return;
      palette.innerHTML = '';
      brandColors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = color;
        swatch.title = color;
        swatch.addEventListener('click', () => {
          if (editor && isInitialized) {
            const selected = editor.getSelected();
            if (selected) selected.addStyle({ 'background-color': color });
            else navigator.clipboard.writeText(color).then(() => console.log('Color copied to clipboard:', color));
          }
        });
        palette.appendChild(swatch);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeEditor();
      populateTemplateGrid();
      populateBrandColors();
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          filterTemplates(e.target.dataset.category);
        });
      });

      // Close modal on outside click
      const templateModal = document.getElementById('templateModal');
      if (templateModal) templateModal.addEventListener('click', (e) => { if (e.target.classList.contains('template-modal')) closeTemplateModal(); });

      // Close brand colors panel when clicking outside
      document.addEventListener('click', (e) => {
        const brandColorsEl = document.getElementById('brandColors');
        const brandColorBtn = document.getElementById('brand-colors');
        if (brandColorsEl && !brandColorsEl.contains(e.target) && e.target !== brandColorBtn) brandColorsEl.classList.remove('active');
      });
    });

    window.closeTemplateModal = closeTemplateModal;
    window.editor = editor;
  </script>
</body>
</html>
